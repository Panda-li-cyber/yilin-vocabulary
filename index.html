<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‹±è¯­è¯æ±‡æ™ºå­¦ç³»ç»Ÿ - ç†ŠçŒ«æEnglishå·¥ä½œå®¤</title>
    <script src="Data.js"></script>
    <style>
        :root { --primary: #4a90e2; --success: #28a745; --bg: #f0f2f5; --word-blue: #007bff; }
        body { font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif; background: var(--bg); margin: 0; padding: 20px; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 30px; border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        
        .main-title { text-align: center; margin-bottom: 5px; color: #2d3436; }
        .sub-title { text-align: center; font-size: 13px; color: #636e72; margin-bottom: 25px; letter-spacing: 1px; }

        #main-header { border-bottom: 2px solid #eee; margin-bottom: 25px; padding-bottom: 15px; }
        .controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        
        .unit-selector { position: relative; }
        .dropbtn { background: var(--primary); color: white; padding: 12px 25px; border: none; cursor: pointer; border-radius: 8px; font-weight: bold; }
        .dropdown-content { 
            display: none; position: absolute; background: white; box-shadow: 0 12px 24px rgba(0,0,0,0.15); 
            z-index: 1000; width: 520px; border-radius: 12px; padding: 15px; 
            grid-template-columns: repeat(2, 1fr); gap: 10px; max-height: 500px; overflow-y: auto;
        }
        .dropdown-content a { color: #333; padding: 10px; text-decoration: none; border-radius: 6px; font-size: 14px; text-align: center; background: #f1f3f5; transition: 0.2s; }
        .dropdown-content a:hover { background: var(--primary); color: white; }

        .tabs { display: flex; gap: 10px; background: #e9ecef; padding: 6px; border-radius: 12px; margin-bottom: 25px; }
        .tab-btn { flex: 1; padding: 14px; border: none; background: transparent; cursor: pointer; border-radius: 8px; font-weight: bold; color: #555; }
        .tab-btn.active { background: white; color: var(--primary); box-shadow: 0 4px 10px rgba(0,0,0,0.08); }

        .study-card { border: 1px solid #e0e0e0; margin-bottom: 30px; width: 100%; border-collapse: collapse; border-radius: 12px; overflow: hidden; }
        .study-card td { border: 1px solid #f0f0f0; padding: 18px; }
        .index-cell { width: 50px; background: #f8f9fa; text-align: center; font-weight: bold; color: #999; font-size: 1.2em; vertical-align: middle; }
        .word-header { color: var(--word-blue); font-size: 1.8em; font-weight: bold; cursor: pointer; }
        .ipa-green { color: var(--success); font-family: 'Arial'; margin-left: 10px; font-weight: normal; }
        .label-cell { background: #fafafa; font-weight: bold; width: 100px; color: #636e72; }

        .flip-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 20px; }
        .flip-container { perspective: 1000px; height: 180px; cursor: pointer; }
        .flip-card { position: relative; width: 100%; height: 100%; transition: 0.6s; transform-style: preserve-3d; }
        .flip-card.is-flipped { transform: rotateY(180deg); }
        .flip-front, .flip-back { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 16px; border: 2px solid #edf2f7; background: white; padding: 15px; text-align: center; }
        .flip-back { transform: rotateY(180deg); background: #f8fbff; }
        .word-bold-blue { color: var(--word-blue); font-weight: bold; font-size: 1.6em; }
        .ipa-green-text { color: var(--success); font-size: 1.1em; margin: 5px 0; }
        .meaning-black { color: #000; font-size: 1.1em; }

        .quiz-box { text-align: center; padding: 30px; }
        .quiz-target { font-size: 1.5em; color: #2d3436; margin-bottom: 25px; font-weight: bold; background: #f8f9fa; padding: 15px; border-radius: 10px; display: inline-block; min-width: 200px; }
        .options-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 10px; }
        .option-btn { padding: 22px; border: 2px solid #eee; background: white; border-radius: 12px; cursor: pointer; font-size: 1.1em; transition: 0.2s; color: #444; }
        .option-btn:hover { border-color: var(--primary); background: #f0f7ff; }

        .hidden { display: none; }
    </style>
</head>
<body onclick="handleFirstClick()">

<div class="container">
    <h1 class="main-title">è‹±è¯­è¯æ±‡æ™ºå­¦ç³»ç»Ÿ</h1>
    <p class="sub-title">ç†ŠçŒ«æEnglishå·¥ä½œå®¤ æå›½ä¿</p>

    <div id="main-header">
        <h2 id="pageTitle" style="text-align: center; color: #34495e;">è¯æ±‡åŠ è½½ä¸­...</h2>
        <div class="controls">
            <div class="unit-selector">
                <button class="dropbtn" id="currentUnitDisplay" onclick="toggleDropdown()">é€‰æ‹©å•å…ƒ â–¼</button>
                <div id="unitDropdown" class="dropdown-content"></div>
            </div>
            <div style="font-size: 14px; color: #666;">
                ğŸµ èƒŒæ™¯éŸ³: <input type="checkbox" id="bgmToggle" onchange="toggleBGM()">
            </div>
        </div>
        <div class="tabs">
            <button class="tab-btn active" id="btn-study" onclick="switchTab('study')">ğŸ“– å­¦å­¦çœ‹</button>
            <button class="tab-btn" id="btn-flip" onclick="switchTab('flip')">ğŸ”„ ç¿»ç¿»çœ‹</button>
            <button class="tab-btn" id="btn-quiz" onclick="switchTab('quiz')">ğŸ† é€‰é€‰çœ‹</button>
        </div>
    </div>

    <div id="mode-container">
        <div id="studyMode" class="mode-content"></div>
        <div id="flipMode" class="mode-content hidden">
            <div style="text-align:center; margin-bottom: 20px; display:flex; justify-content:center; gap:15px;">
                <button class="dropbtn" style="background:#6c757d" onclick="initFlip('CE')">ä¸­ â” è‹±æ¨¡å¼</button>
                <button class="dropbtn" style="background:#6c757d" onclick="initFlip('EC')">è‹± â” ä¸­æ¨¡å¼</button>
            </div>
            <div id="flipArea" class="flip-grid"></div>
        </div>
        <div id="quizMode" class="mode-content hidden">
            <div id="quizInit" style="text-align:center;">
                <button class="dropbtn" onclick="startQuiz('CE')" style="margin-right:15px;">ä¸­-è‹±æŒ‘æˆ˜</button>
                <button class="dropbtn" onclick="startQuiz('EC')">è‹±-ä¸­æŒ‘æˆ˜</button>
            </div>
            <div id="quizArea" class="quiz-box hidden"></div>
        </div>
    </div>
</div>

<audio id="bgm" loop src="https://assets.mixkit.co/music/preview/mixkit-sunny-day-28.mp3"></audio>

<script>
    let currentUnitData = [];
    let qIdx = 0;
    let audioContextUnlocked = false;

    // å¤„ç†æµè§ˆå™¨éŸ³é¢‘é™åˆ¶ï¼šç¬¬ä¸€æ¬¡ç‚¹å‡»é¡µé¢æ¿€æ´»éŸ³é¢‘
    function handleFirstClick() {
        if (!audioContextUnlocked) {
            const context = new (window.AudioContext || window.webkitAudioContext)();
            context.resume();
            audioContextUnlocked = true;
            console.log("éŸ³é¢‘ä¸Šä¸‹æ–‡å·²æ¿€æ´»");
        }
    }

    // å•å…ƒæ ‡ç­¾ç¾åŒ–
    function formatUnitLabel(u) {
        if(!u) return "";
        const code = u.toString().toLowerCase();
        const num1 = code.match(/\d/)?.[0];
        const num2 = code.split('u')[1];
        if(code.startsWith('b')) return `å¿…ä¿® ${num1} Unit ${num2}`;
        if(code.startsWith('x')) return `é€‰æ‹©æ€§å¿…ä¿® ${num1} Unit ${num2}`;
        return u;
    }

    // é¡µé¢åˆå§‹åŒ–ï¼šç›´æ¥ä» data.js åŠ è½½
    window.onload = function() {
        if (typeof vocabData !== 'undefined') {
            // é¢„å¤„ç†å°å†™åŒ¹é…
            vocabData.forEach(item => { if(item.å•å…ƒ) item.å•å…ƒ = item.å•å…ƒ.toString().toLowerCase(); });
            
            setupUnitDropdown();
            document.getElementById('main-header').style.display = 'block';
            
            const firstUnit = [...new Set(vocabData.map(i => i.å•å…ƒ))].sort()[0];
            selectUnit(firstUnit);
        } else {
            alert("é”™è¯¯ï¼šæœªæ‰¾åˆ° data.js æ–‡ä»¶ï¼Œè¯·ç¡®ä¿å®ƒä¸ index.html åœ¨åŒä¸€æ–‡ä»¶å¤¹ä¸‹ã€‚");
        }
    };

    function setupUnitDropdown() {
        const units = [...new Set(vocabData.map(item => item.å•å…ƒ))].sort();
        const dropdown = document.getElementById('unitDropdown');
        dropdown.innerHTML = units.map(u => `<a href="javascript:void(0)" onclick="selectUnit('${u}')">${formatUnitLabel(u)}</a>`).join('');
    }

    function selectUnit(u) {
        currentUnitData = vocabData.filter(item => item.å•å…ƒ === u);
        document.getElementById('currentUnitDisplay').textContent = formatUnitLabel(u) + " â–¼";
        document.getElementById('pageTitle').textContent = formatUnitLabel(u) + " äº’åŠ¨æ•™å­¦åŒº";
        document.getElementById('unitDropdown').style.display = 'none';
        switchTab('study');
    }

    function toggleDropdown() {
        const d = document.getElementById('unitDropdown');
        d.style.display = d.style.display === 'grid' ? 'none' : 'grid';
    }

    function renderStudyMode() {
        const container = document.getElementById('studyMode');
        container.innerHTML = currentUnitData.map((item, index) => `
            <table class="study-card">
                <tr>
                    <td rowspan="5" class="index-cell">${index + 1}</td>
                    <td colspan="2" class="word-header" onclick="speak('${item.å•è¯}')">
                        ${item.å•è¯} <span class="ipa-green">/${item.éŸ³æ ‡ || ''}/</span>
                    </td>
                </tr>
                <tr><td class="label-cell">è¯ä¹‰</td><td>${item.æ„ä¹‰ || ''}</td></tr>
                <tr style="cursor:pointer" onclick="speak('${item.ä¾‹å¥?.replace(/'/g, "\\'")}')">
                    <td class="label-cell">ä¾‹å¥</td>
                    <td>${item.ä¾‹å¥ || ''}<br><small style="color:#666">${item.ç¿»è¯‘ || ''}</small></td>
                </tr>
                <tr><td class="label-cell">è®°å¿† 1</td><td style="color:#e67e22">${item.ç‰¹æ®Šè®°å¿†1 || item.è®°å¿†æ³•1 || ''}</td></tr>
                <tr><td class="label-cell">è®°å¿† 2</td><td style="color:#e67e22">${item.ç‰¹æ®Šè®°å¿†2 || item.è®°å¿†æ³•2 || ''}</td></tr>
            </table>
        `).join('') + '<div style="height:40px;"></div>';
    }

    function initFlip(mode) {
        const area = document.getElementById('flipArea');
        area.innerHTML = currentUnitData.map(item => {
            const front = mode === 'CE' ? 
                `<div class="meaning-black">${item.æ„ä¹‰}</div>` : 
                `<div class="word-bold-blue">${item.å•è¯}</div><div class="ipa-green-text">/${item.éŸ³æ ‡}/</div><div style="margin-top:10px">ğŸ”Š</div>`;
            const back = mode === 'CE' ? 
                `<div class="word-bold-blue">${item.å•è¯}</div><div class="ipa-green-text">/${item.éŸ³æ ‡}/</div>` : 
                `<div class="meaning-black">${item.æ„ä¹‰}</div>`;

            return `<div class="flip-container" onclick="handleFlip(this, '${item.å•è¯}')"><div class="flip-card"><div class="flip-front">${front}</div><div class="flip-back">${back}</div></div></div>`;
        }).join('');
    }

    function handleFlip(el, word) {
        el.querySelector('.flip-card').classList.toggle('is-flipped');
        speak(word);
    }

    function startQuiz(type) {
        qType = type; qIdx = 0;
        document.getElementById('quizInit').classList.add('hidden');
        document.getElementById('quizArea').classList.remove('hidden');
        showQuestion();
    }

    function showQuestion() {
        if(qIdx >= currentUnitData.length) {
            document.getElementById('quizArea').innerHTML = `<h2>æŒ‘æˆ˜å®Œæˆ!</h2><button class="dropbtn" onclick="switchTab('quiz')">è¿”å›</button>`;
            return;
        }
        const correct = currentUnitData[qIdx];
        let options = [...vocabData.filter(i => i.å•è¯ !== correct.å•è¯).sort(() => 0.5-Math.random()).slice(0,3), correct].sort(() => 0.5-Math.random());
        document.getElementById('quizArea').innerHTML = `
            <div class="quiz-target">${qType === 'EC' ? correct.å•è¯ : correct.æ„ä¹‰}</div>
            <div class="options-grid">${options.map(opt => `<button class="option-btn" onclick="checkAnswer('${opt.å•è¯}', '${correct.å•è¯}')">${qType === 'EC' ? opt.æ„ä¹‰ : opt.å•è¯}</button>`).join('')}</div>
        `;
    }

    function checkAnswer(sel, act) {
        if(sel === act) {
            new Audio('https://assets.mixkit.co/active_storage/sfx/600/600-preview.mp3').play();
            qIdx++; showQuestion();
        } else {
            new Audio('https://assets.mixkit.co/active_storage/sfx/951/951-preview.mp3').play();
        }
    }

    function switchTab(mode) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.mode-content').forEach(d => d.classList.add('hidden'));
        document.getElementById('btn-' + mode)?.classList.add('active');
        document.getElementById(mode + 'Mode').classList.remove('hidden');
        if(mode === 'study') renderStudyMode();
        if(mode === 'quiz') { document.getElementById('quizInit').classList.remove('hidden'); document.getElementById('quizArea').classList.add('hidden'); }
    }

    function speak(t) { 
        window.speechSynthesis.cancel();
        const m = new SpeechSynthesisUtterance(t); 
        m.lang = 'en-US'; 
        window.speechSynthesis.speak(m); 
    }

    function toggleBGM() {
        const b = document.getElementById('bgm');
        const toggle = document.getElementById('bgmToggle');
        if (toggle.checked) {
            b.play().catch(() => {
                alert("è¯·å…ˆç‚¹å‡»ç½‘é¡µä»»æ„ä½ç½®ï¼Œå†å¼€å¯éŸ³ä¹ã€‚");
                toggle.checked = false;
            });
        } else {
            b.pause();
        }
    }
</script>
</body>

</html>
